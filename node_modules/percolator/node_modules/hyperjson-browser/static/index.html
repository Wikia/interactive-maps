<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>percolator.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }

      pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
      .string { color: green; }
      .number { color: darkorange; }
      .boolean { color: blue; }
      .null { color: magenta; }
      .key { color: black; }

    </style>
    <link href="css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="js/superagent.js"></script>
    <script src="js/bootbox.min.js"></script>
    <script src="js/underscore-min.js"></script>
    <script src="js/uri-template.js"></script>
    <script>

      var statusCodes = {
        "100": "Continue",
        "101": "Switching Protocols",
        "102": "Processing",
        "200": "OK",
        "201": "Created",
        "202": "Accepted",
        "203": "Non-Authoritative Information",
        "204": "No Content",
        "205": "Reset Content",
        "206": "Partial Content",
        "207": "Multi-Status",
        "208": "Already Reported",
        "226": "IM Used",
        "300": "Multiple Choices",
        "301": "Moved Permanently",
        "302": "Found",
        "303": "See Other",
        "304": "Not Modified",
        "305": "Use Proxy",
        "306": "Reserved",
        "307": "Temporary Redirect",
        "308": "Permanent Redirect",
        "400": "Bad Request",
        "401": "Unauthorized",
        "402": "Payment Required",
        "403": "Forbidden",
        "404": "Not Found",
        "405": "Method Not Allowed",
        "406": "Not Acceptable",
        "407": "Proxy Authentication Required",
        "408": "Request Timeout",
        "409": "Conflict",
        "410": "Gone",
        "411": "Length Required",
        "412": "Precondition Failed",
        "413": "Request Entity Too Large",
        "414": "Request-URI Too Long",
        "415": "Unsupported Media Type",
        "416": "Requested Range Not Satisfiable",
        "417": "Expectation Failed",
        "422": "Unprocessable Entity",
        "423": "Locked",
        "424": "Failed Dependency",
        "425": "Unordered Collection",
        "426": "Upgrade Required",
        "427": "Unassigned",
        "428": "Precondition Required",
        "429": "Too Many Requests",
        "430": "Unassigned",
        "431": "Request Header Fields Too Large",
        "500": "Internal Server Error",
        "501": "Not Implemented",
        "502": "Bad Gateway",
        "503": "Service Unavailable",
        "504": "Gateway Timeout",
        "505": "HTTP Version Not Supported",
        "506": "Variant Also Negotiates",
        "507": "Insufficient Storage",
        "508": "Loop Detected",
        "509": "Bandwidth Limit Exceeded",
        "510": "Not Extended",
        "511": "Network Authentication Required"
    };

      if (!console){
        console = { log : function(){} };
      }

      function uriParse(uri){
        var parsed = document.createElement('a');
        // parsed has these properties:   protocol, hostname, port, pathname, search, hash, host
        parsed.href = uri;
        return parsed;
      }

      function qs(key) {
        var re=new RegExp('(?:\\?|&)'+key+'=(.*?)(?=&|$)','gi');
        var r=[], m;
        while ((m=re.exec(document.location.search)) !== null){
          r.push(unescape(m[1]));
        }
        return r;
      }

       function htmlEncode(str){
         return str;
         return str.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
       }

       function relink(href){
         // create a link that goes through /browser again,
         // unless it's to another domain.
         console.log("href: ", href);
         var parsed = uriParse(href);
         console.log("Parsed: ", parsed);
         console.log("host: ", parsed.host);
         var hostIndex = href.indexOf(parsed.host);
         if (hostIndex != -1){
           console.log("found");
           var currentUriParsed = uriParse(window.location.href);
           console.log(currentUriParsed.protocol);
           console.log(currentUriParsed.host);
           if (currentUriParsed.host !== parsed.host){
             // it's another domain.  don't link through /browser.
             return href;
           }
           href = href.slice(hostIndex + parsed.host.length);
         }
         href = '?href=' + escape(href);
         console.log("returning: ", href);
         return href;
       }

      var hasUriTemplate = function(href){
        return href.indexOf('{') !== -1;
      }

       function linkify(_links){
         console.log("links in: ", _links);
         for(linkname in _links){
           var v = _links[linkname];
           if (!!v.method && v.method !== 'GET'){
             if (v.method === "DELETE"){
               v.href = "<a class='deleteLink' href='#'>" + v.href + '</a>';
             }
             if (v.method === "POST"){
               v.href = "<a class='postLink' href='#'>" + v.href + '</a>';
             }
             if (v.method === "PUT"){
               v.href = "<a class='putLink' href='#'>" + v.href + '</a>';
             }
           } else {
             if (hasUriTemplate(v.href)){
               v.href = "<a class='getLink' href='#'>" + v.href + '</a>';
             } else {
               v.href = "<a href='" + relink(v.href) + "'>" + v.href + '</a>';
             }
           }
           if (v.method){
             v.method = '<strong>' + v.method + '</strong>';
           }
         };
         console.log('links out: ', _links);
         return _links;
       }

       function traverse(obj,func) {
         _.each(obj, function(v, k){
           if (func(k,v,obj)){
             if (typeof(v)=="object") {
               //going on step down in the object tree!!
               traverse(v,func);
             }
           }
         });
       }

       function formatKeyValue(key, value, obj){
           console.log("called handler");
           if (key === "_links"){
             console.log("linkifying");
             obj['<strong>_links</strong>'] = linkify(value);
             delete obj._links;
             return false;
           } else {
             if (typeof value === 'string'){
               console.log("string: ", value);
               obj[key] = htmlEncode(value);
             }
             return true;
           }
       }

       function render(obj){
         traverse(obj, formatKeyValue);
         //console.log('pre-stringify: ', obj);

         var json = JSON.stringify(obj, null, 4);
         //console.log('post-stringify: ', json);
         return json;
       }

       function headersToHtml(headers){
         var html = '';
         for(var k in headers){
           v = headers[k];
           html += '<dl class="dl-horizontal"><dt>' + k + '</dt><dd>' + v + '</dd></dl>';
         }
         return html;
       }

       function statusToHtml(status){
         var type = '';
         switch(true){
           case (status >= 200 && status < 300) : type = 'badge-success'; break;
           case (status >= 300 && status < 400) : type = 'badge-info'; break;
           case (status >= 400) : type = 'badge-important'; break;
         }
         var retval = '<span class="badge ' + 
                      type + 
                      '">' + 
                      status + 
                      '</span>: ';
         if (statusCodes[status]){
           retval += statusCodes[status];
         } else {
           retval += 'Unknown status code.';
         }
         console.log("retval: ", retval);
         return retval;
       }

       var uriParamNames = [];

       function getInputForm(method, url, schema){
         var retval = "url " + url + " .";
         var urlParams = url.match(/{([^}]+)}/g);
         uriParamNames = [];
         retval += '<form class="inputForm">';
         if (urlParams && (urlParams.length > 0)){
           retval += '<fieldset>';
           retval += '<legend>URL Parameters</legend>';
           _.each(urlParams, function(param){
             var name = param.slice(1, -1);
             uriParamNames.push(name)
             retval += '<label>';
             retval += name + ': <input type="text" name="URI_PARAM_';
             retval += name + '" value="" />';
             retval += '</label>';
           });
           retval += '</fieldset>';
         }
         retval += '<fieldset>';
         if (method !== "GET"){
           retval += '<div class="row">'
           retval += '<div class="span3">'
           retval += '<legend>Body</legend>';
           retval += '<textarea name="body"></textarea>';
           retval += '</div>'
           retval += '<div class="span1" id="jsonimg">'
           retval += '<img src="img/badjson.png">';
           retval += '</div>'
           retval += '</div>'
         }
         retval += '</form>';
         return retval;
       }

       function getUriParamFormField(name){
         //console.log("checking: ", name);
         var retval = $("form.inputForm input[name=URI_PARAM_" + name + "]").val()
         //console.log("returning: ", retval);
         return retval;
       }

       var handleResponse = function(res){
         console.log("response: ", res);
         // there's a res.header object
         //alert('status: ' + res.status + "\nbody: " + res.body);
         populateHtmlFromResponse(res);
       }

       var populateHtmlFromResponse = function(res){
          $('#responseStatus').html(statusToHtml(res.status));
          $('#responseHeaders').html(headersToHtml(res.header));
          console.log("body ", typeof res.body, res.body);
          console.log("text ", typeof res.text, res.text);
          var body = res.body;
          try {
            body = JSON.parse(res.text);
          } catch(ex){
            body = '';
          }
          console.log("cleaned ", typeof body , body);
          console.log("cleaned string", typeof body , JSON.stringify(body));

          if (body != ""){
            $('#loaded').html(render(body));
          } else {
            $('#loaded').html('');
          }
       }

       var onBodyFieldChange = function(ev){
         //console.log(ev);
         var current = $(ev.target).val();
         try {
           JSON.parse(current);
           console.log("good");
           $('#jsonimg').html('<img title="valid json" src="img/goodjson.png" />');
         } catch(ex){
           console.log("bad");
           $('#jsonimg').html('<img  title="invalid json" src="img/badjson.png" />');
         }
       }

       function retrieveUrl(url){
          superagent
            .get(url)
            .set('Accept', 'application/json')
            .end(function(res){
              populateHtmlFromResponse(res);

              var getWriteLinkHandler = function(httpMethod){
              var writeLinkHandler = function(ev){
                var delUrl = $(ev.currentTarget).text();
                var schema = {};  // TODO get the real schema
                var form = $(getInputForm(httpMethod, delUrl, schema));
                var submit = function(form){
                  console.log(uriParamNames);
                  var paramDict = {};
                  var error = false;
                  _.each(uriParamNames, function(name){
                    paramDict[name] = getUriParamFormField(name);
                    if (paramDict[name] === ''){
                      error = "You must complete all form fields.";
                    }
                  });
                  if (error){
                    alert(error);
                    return true;
                  }
                  var submitUri = uriTemplate(delUrl)(paramDict);
                  console.log(form);
                  var bodyField = $("form.inputForm textarea[name=body]");
                  var body = bodyField.val();
                  console.log("body: ", body);
                  superagent[httpMethod.toLowerCase()](submitUri)
                    .send(body)
                    .set('Content-Type', 'application/json')
                    .end(function(res){
                      handleResponse(res);
                    });
                };
                bootbox.dialog(form,
                              [
                                {
                                label : "OK",
                                 callback : function(){
                                   submit(form);
                                 }
                                },
                                {
                                 label : "CANCEL",
                                 callback : function(){
                                   return null;
                                 }
                               }
                                ],
                                {
                                  // prompts need a few extra options
                                  "header"  : httpMethod + " ",
                                  // explicitly tell dialog NOT to show the dialog...
                                  //???  "show"    : false,
                                  "onEscape": function(){return null}
                                }
                                );
                var bodyField = $("form.inputForm textarea[name=body]");
                bodyField.keyup(onBodyFieldChange);

                /*, function(shouldDoIt){
                  if (shouldDoIt){
                    superagent.put(delUrl).end(function(res){
                      console.log("response: ", res);
                      alert('status: ' + res.status + "\nbody: " + res.body);
                    });
                  }
                });*/
              
              };
              return writeLinkHandler;
            }

              $('.putLink').click(getWriteLinkHandler('PUT'));
              $('.getLink').click(getWriteLinkHandler('GET'));
              $('.postLink').click(getWriteLinkHandler('POST'));
              $('.deleteLink').click(function(ev){
                var delUrl = $(ev.currentTarget).text();
                var confirmMsg = "Really delete " + delUrl + "?";
                bootbox.confirm(confirmMsg, function(shouldDoIt){
                  if (shouldDoIt){
                    superagent.del(delUrl).end(function(res){
                      //console.log("response: ", res);
                      //alert('status: ' + res.status + "\nbody: " + res.body);
                      populateHtmlFromResponse(res);
                    });
                  }
                });
              });
            });
       }

       $(function(){
         var url = qs('href')[0] || '/$$API_PATH$$';
         console.log("url : ", url);

         $('#urlField').val(url);
         retrieveUrl(url);


         $('#goBtn').click(function(btn){
          var url = $('#urlField').val();
          retrieveUrl(url);
         });
       
       });
    </script>
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/"><img src="img/headr-nav.png" /></a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active"><a
                href="/$$MOUNT_PATH$$/?href=%2F$$API_PATH$$">Home</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">
      <p>Location: <form>
        <input type="text" name="url" id="urlField" value="/$$API_PATH$$" />
        <input type="button" id="goBtn" value="GO" />
      </form></p>
      <div class="row">
        <div class="span1">
          <h4>Status: </h4>
        </div>
        <div class="span1">
          <div id="responseStatus"></div>
        </div>
      </div>
      <h4>Body:</h4>
      <pre>
      <div id="loaded"></div>
      </pre>
      <div class="row">
        <div class="span12">
          <h4>Headers:</h4>
        </div>
        <div class="span12">
          <div id="responseHeaders"></div>
        </div>
      </div>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/bootstrap-transition.js"></script>
    <script src="js/bootstrap-alert.js"></script>
    <script src="js/bootstrap-modal.js"></script>
    <script src="js/bootstrap-dropdown.js"></script>
    <script src="js/bootstrap-scrollspy.js"></script>
    <script src="js/bootstrap-tab.js"></script>
    <script src="js/bootstrap-tooltip.js"></script>
    <script src="js/bootstrap-popover.js"></script>
    <script src="js/bootstrap-button.js"></script>
    <script src="js/bootstrap-collapse.js"></script>
    <script src="js/bootstrap-carousel.js"></script>
    <script src="js/bootstrap-typeahead.js"></script>
    <script src="js/bootstrap-affix.js"></script>
  </body>
</html>

